一、获取制作iso的文件

1）下载CentOS-6.3-x86_64-bin-DVD1.iso

2）挂载CentOS-6.3-x86_64-bin-DVD1.iso
#mkdir iso
#mount -o loop CentOS-6.3-x86_64-bin-DVD1.iso iso
3）获取文件
#mkdir adsg-iso
#cd iso
#tar -cf - . | ( cd ../adsg-iso ; tar -xvpf - )
二、制作ks.cfg   

1）用CentOS-6.3-x86_64-bin-DVD1.iso
iso安装一个虚拟机A（内存至少1G，硬盘至少5G），安装时安装包选择：Base
System->Base；Database->PostgreSQL Database server

2）在A的/root/目录下找到anaconda-ks.cfg文件，将其复制到adsg-iso/solinux/目录并命名为ks.cfg，然后将其修改为如下内容：

# Kickstart file automatically generated by anaconda.

#version=DEVEL

install

text

cdrom

lang en_US.UTF-8

keyboard us

rootpw  --iscrypted
$6$rGzWDoBNhk3aXAcZ$Utqg3e2JL0.ukF16N7X09dGh242o/kmTQ8ZlNRb40RmOGgoDwMInGQpDSUFq1yT/SIWi7dz50rJ.Ojvs38Gqe1

firewall --disabled

authconfig --enableshadow --passalgo=sha512

selinux --disabled

timezone --utc Asia/Shanghai

bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb
quiet"

# The following is the partition information you requested

# Note that any partitions you deleted are not expressed

# here so unless you clear all partitions first, this is

# not guaranteed to work

clearpart --all

part /boot --fstype=ext4 --size=100

part swap --size=500

part / --fstype=ext4 --grow --size=200

reboot

%packages

@base

@core

@postgresql

@server-policy

java-1.7.0-openjdk

sgpio

%end
三、 修改isolinux.cfg


1）赋予isolinux.cfg可写权限：

#chmod +w adsg-iso/isolinux/isolinux.cfg

2）修改其为如下内容：
default ks
prompt 1
timeout 1

label ks
menu default
kernel vmlinuz
append ks=cdrom:/isolinux/ks.cfg initrd=initrd.img
label local
localboot 1
label memtest86
menu label ^Memory test
kernel memtest
append -
四、获取基础RPM包

1）生成RPM包的依赖关系：

#cd adsg-iso

#createrepo -g repodata/*comps.xml .

                         2）生成test.iso文件：

#mkisofs -R -T -r -l -d -allow-multidot -allow-leading-dots
-no-bak -o ~/test.iso -b isolinux/isolinux.bin -c
isolinux/boot.cat -no-emul-boot -boot-load-size 4
-boot-info-table .

3）在虚拟机A中安装test.iso

4）安装完毕后找到A的/root/目录下的install.log文件

5）生成所安装的全部RPM的列表：



cat install.log | grep Installing | sed 's/Installing //g'|sed
's/^[0-9]\+://g' > packages.list

6）导出packages.list

7）移出原有的RPM包：

#mv Packages ~/orig-Packages

#mkdir Packages

8）生成cprpms.sh，内容如下：

#!/bin/bash

set -e

usage()

{

echo "$0 src dst packages_list"

}

SRC=$1

DST=$2

packages_list=$3

if [ $# -ne 3 ]; then

usage

exit 1

fi

while read name

do

echo "cp $SRC/$name* $DST/"

cp $SRC/$name* $DST/

# in case the copy failed

if [ $? -ne 0 ] ; then

echo "cp $SRC/$name failed
"

fi

done < $packages_list


9）摘取必需的RPM包：

bash cprpms.sh
~/orig-Packages
Packages
~/packages.list
五、生成ADSG的iso文件  

1）添加ADSG的RPM包到adsg-iso/Packages

2）编辑adsg-iso/isolinux/ks.cfg，将adsg各个RPM包的名称添加到%end之前：

%packages

@base

@core

@postgresql

@server-policy

java-1.7.0-openjdk

sgpio

adsg-xx

adsg-xxx

%end

3）生成RPM包的依赖关系：

#cd adsg-iso

#createrepo -g
repodata/*comps.xml .

          2）生成ADSG.iso文件：

#mkisofs -R -T -r -l -d
-allow-multidot
-allow-leading-dots
-no-bak -o ~/ADSG.iso
-b
isolinux/isolinux.bin
-c isolinux/boot.cat
-no-emul-boot
-boot-load-size 4
-boot-info-table .


上述功能可以通过一个脚本完成：
脚本名称 svn路径 参数
参数说明
mkiso.shhttp://darkstar0:8040/svn/DarkStar/branches/v1/build-deploy-test
-n [product_name]
指定产品名称，如，adsg
-v [product_version]
指定产品主版本号
-s [svn_version]
指定svn版本号
-d [output_dir]
指定ISO文件到输出目录。如果这个目录不存在则会创建
-o [iso_file_dir]
指定制作ISO所需的文件所在到目录
-i [install_file]
指定制作ISO所需的install文件


六、网络安装

网络安装必需用kickstart完成。这种安装方式能够达到“无人值守”的目标。方法与步骤如下：
1）搭建PXE网络安装服务器S1与ftp服务器S2(无人值守安装LINUX操作系统.pdf)
2）上传ADSG.iso文件到S2
3）将ADSG.iso文件mount到/var/ftp/pub/adsg-img目录：

mount ADSG.iso -o loop
/var/ftp/pub/adsg-img
4）编辑ks.cfg，在注释掉“cdrom”后增加：
url --url
ftp://IP-OF-S2//pub/adsg-img
5）将ks.cfg上传到S2的/var/ftp/pub目录下

6）将ADSG.iso中的vmlinuz和initrd上传到S1的/tftpboot目录下：

#scp
/var/ftp/adsg/isolinux/vmlinuz
root@IP_OF_S1/tftpboot/vmlinuz.adsg

#scp
/var/ftp/adsg/isolinux/initrd.img
root@IP_OF_S1/tftpboot/initrd.img.adsg
7）编辑S1的/tftpboot/pxelinux.cfg/default，增加：
label adsg
kernel vmlinuz.adsg
append
initrd=initrd.img.adsg
ks=ftp://IP-OF-S2/pub/ks.cfg
ksdevice=eth0

8）PXE引导成功后，在“boot：”提示后输入“adsg”回车就可以自动完成系统安装。


